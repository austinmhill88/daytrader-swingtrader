# Model Promotion Gates Configuration
# Defines numerical thresholds that models must pass to be promoted to production

# Out-of-Sample Performance Thresholds
performance_thresholds:
  # Sortino Ratio: Focus on downside risk (primary metric)
  min_sortino_ratio: 1.0
  
  # Sharpe Ratio: Traditional risk-adjusted return (secondary check)
  min_sharpe_ratio: 1.0
  
  # Maximum Drawdown: Limit worst-case loss
  max_drawdown_pct: 10.0
  
  # Win Rate: Avoid strategies with too many small losses
  min_win_rate: 0.45
  
  # Total Trades: Ensure sufficient sample size for statistical significance
  min_total_trades: 100
  
  # Profit Factor: Gross profit / Gross loss
  min_profit_factor: 1.3
  
  # Calmar Ratio: Return / Max DD (for swing strategies)
  min_calmar_ratio: 1.5

# Strategy-specific thresholds (override defaults)
strategy_specific:
  intraday_mean_reversion:
    min_total_trades: 200  # Higher threshold for intraday (more trades expected)
    max_drawdown_pct: 8.0  # Tighter DD for intraday
  
  swing_trend_following:
    min_total_trades: 50   # Lower threshold for swing (fewer trades expected)
    min_calmar_ratio: 2.0  # Higher Calmar for swing strategies

# Anti-Overfitting Diagnostics
anti_overfitting:
  # Probability of Backtest Overfitting: < 50% (prefer < 30%)
  max_pbo: 0.5
  pbo_conservative: 0.3  # Alert if PBO > 0.3 even if passing
  
  # Deflated Sharpe Ratio: Adjust for multiple testing
  min_deflated_sharpe: 0.5
  deflated_sharpe_conservative: 1.0  # Ideal threshold
  
  # White's Reality Check: P-value for statistical significance
  max_white_reality_check_pvalue: 0.05  # 95% confidence
  
  # Enable/disable specific diagnostics
  enable_pbo: true
  enable_deflated_sharpe: true
  enable_white_reality_check: true

# Stability and Consistency Checks
stability:
  # SHAP Importance Stability: Coefficient of variation across CV folds
  max_shap_cv: 0.3
  top_n_features: 10  # Check stability of top 10 features
  
  # Performance Consistency: % of walk-forward windows with positive returns
  min_positive_windows_pct: 0.70
  
  # Feature Drift Detection
  feature_drift:
    # Kolmogorov-Smirnov statistic
    max_ks_statistic: 0.1
    ks_warning_threshold: 0.08  # Warn if approaching limit
    
    # Population Stability Index
    max_psi: 0.2
    psi_warning_threshold: 0.15  # Warn if approaching limit
  
  # Enable/disable stability checks
  enable_shap_stability: true
  enable_performance_consistency: true
  enable_feature_drift: true

# Minimum Sample Size Requirements
sample_size:
  # Total out-of-sample trades
  min_oos_trades: 100
  
  # Minimum OOS days (at least one full test window)
  min_oos_days: 63
  
  # Minimum number of symbols traded (diversification)
  min_symbols_traded: 10
  
  # Minimum number of walk-forward windows
  min_walk_forward_windows: 3

# Risk-Adjusted Metrics
risk_metrics:
  # Tail Risk: 95th percentile loss per trade
  max_tail_risk_pct: 2.0
  
  # Exposure Utilization: Leave buffer for unexpected opportunities
  max_exposure_utilization: 0.80
  
  # Turnover: Control transaction costs
  max_turnover_annual_pct:
    swing: 500  # 500% annual turnover for swing strategies
    intraday: 2000  # 2000% annual turnover for intraday strategies

# Promotion Workflow Configuration
promotion_workflow:
  # Require manual approval for promotion (even if gates pass)
  require_manual_approval: false
  
  # Notify admins when model passes gates
  notify_on_approval: true
  notification_channels: ["slack", "email"]
  
  # Automatically demote models that fail live performance gates
  auto_demotion_enabled: true
  
  # Live performance monitoring (for demotion)
  live_performance:
    # Monitor live Sharpe over rolling window
    lookback_days: 20
    min_live_sharpe: 0.5
    
    # Monitor live max drawdown
    max_live_drawdown_pct: 15.0  # Exceeds backtest threshold + buffer
    
    # Feature drift threshold for demotion
    max_live_feature_drift_ks: 0.2
    max_live_feature_drift_psi: 0.3
    
    # Consecutive days of failing gates before demotion
    consecutive_fail_days: 5

# Model Retraining Schedule
retraining:
  # Frequency by strategy type
  schedule:
    intraday: "weekly"   # Retrain every Sunday
    swing: "monthly"     # Retrain first Sunday of month
  
  # Trigger-based retraining (override schedule)
  triggers:
    # Retrain if live performance degrades
    performance_degradation:
      enabled: true
      sharpe_threshold: 0.5
      lookback_days: 20
    
    # Retrain if feature drift detected
    feature_drift:
      enabled: true
      ks_threshold: 0.2
      psi_threshold: 0.3
    
    # Retrain if model is too old
    model_age:
      enabled: true
      max_age_days: 90

# Gate Weights (for scoring models)
# If you want to compute an aggregate "gate score" instead of binary pass/fail
gate_weights:
  enabled: false  # Set to true to use weighted scoring
  weights:
    sortino_ratio: 0.20
    sharpe_ratio: 0.15
    max_drawdown: 0.15
    win_rate: 0.10
    profit_factor: 0.10
    pbo: 0.15
    deflated_sharpe: 0.10
    shap_stability: 0.05
  
  # Minimum aggregate score to pass (0-1)
  min_aggregate_score: 0.70

# Logging and Auditing
logging:
  # Log all gate evaluation results
  log_gate_results: true
  log_path: "./logs/promotion_gates.log"
  
  # Store gate results in model registry
  store_in_registry: true
  
  # Detailed logging (include intermediate calculations)
  verbose: false

# Calibration and Review
calibration:
  # Review and recalibrate thresholds quarterly
  review_frequency: "quarterly"
  
  # Track gate failure rates to calibrate thresholds
  track_failure_rates: true
  
  # Conservative mode: Tighten all thresholds by this factor
  conservative_mode: false
  conservative_multiplier: 0.8  # 20% tighter thresholds

# Notes and Documentation
notes: |
  These thresholds are initial conservative values based on industry best practices.
  
  Calibration Process:
  1. Run several models through promotion gates
  2. Review distribution of metrics (Sharpe, PBO, etc.)
  3. Adjust thresholds based on observed distributions
  4. Re-evaluate quarterly as market conditions change
  
  References:
  - "Advances in Financial Machine Learning" by Marcos Lopez de Prado
  - Deflated Sharpe Ratio: Bailey & Lopez de Prado (2014)
  - Probability of Backtest Overfitting: Bailey et al. (2014)
